<!DOCTYPE html>
<html>
<head>
    <title>MapleStory HEXA Stat Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
    <div id="app">
        <h1>MapleStory HEXA Stat Calculator</h1>
        
        <table>
            <tr><td></td><td>Main Stat</td><td>Additional Stats 1</td><td>Additional Stats 2</td></tr>
            <tr v-for="i,k in mains">
                <td>Core {{k+1}}</td>
                <td><input v-model.number="mains[k]" type="number" min="0" max="10"></td>
                <td><input v-model.number="sec0s[k]" type="number" min="0" max="10"></td>
                <td><input v-model.number="sec1s[k]" type="number" min="0" max="10"></td>
            </tr> 
        </table>

        <div>
            <h3>Stat Conversion</h3>
            <table>
                <tr><td>1 mainstat% </td><td>= </td><td><input v-model.number="msp2ms" type="number" min="0" max="100"> main stat</td></tr>
                <tr><td>1 att </td><td>= </td><td><input v-model.number="att2ms" type="number" min="0" max="100"> main stat </td></tr>
                <tr><td>8 crit damage </td><td>= </td><td><input v-model.number="cdmg82msp" type="number" min="0" max="100"> mainstat% </td></tr>
                <tr><td>40 boss </td><td>= </td><td><input v-model.number="boss402attp" type="number" min="0" max="100"> att% </td></tr>
                <tr><td>1 IED </td><td>= </td><td><input v-model.number="ied2boss" type="number" min="0" max="100"> boss </td></tr>
                <tr><td>All mainstat% </td><td> :</td><td><input v-model.number="allmstatp" type="number" min="0" max="1000"> % </td></tr>
                <tr><td>All att </td><td> :</td><td><input v-model.number="allatt" type="number" min="0" max="100000"> att </td></tr>
                <tr><td>All att% </td><td> :</td><td><input v-model.number="allattp" type="number" min="0" max="1000"> att% </td></tr>
                <tr><td>All mainstat </td><td> :</td><td><input v-model.number="allmstat" type="number" min="0" max="200000"> main stat </td></tr>
            </table>
        </div>
        <div>
            <h3>Score Estimate</h3>
            <table>
                <tr><td>5 att </td><td>= </td><td> {{scatt5}} main stat</td></tr>
                <tr><td>0.35% crit damage </td><td>= </td><td> {{sccd35}} main stat</td></tr>
                <tr><td>100 final stat </td><td>= </td><td> {{scms100}} main stat </td></tr>
                <tr><td>1% boss </td><td>= </td><td> {{scboss}} main stat</td></tr>
                <tr><td>1% IED </td><td>= </td><td> {{scied}} main stat</td></tr>
                <tr><td>0.75% damage </td><td>= </td><td> {{scdmg75}} main stat</td></tr>
            </table>
        </div>
        <div>
            <button v-on:click="search">Search</button>
            Result: +{{result}} main stats
            <table v-if="plan">
                <tr><td></td><td>Main Stat</td><td>Additional Stats 1</td><td>Additional Stats 2</td></tr>
                <tr v-for="i,k in mains">
                    <td>Core {{k+1}}</td>
                    <td>{{mains[k]}}x{{plan[k][0]}}</td>
                    <td>{{sec0s[k]}}x{{plan[k][1]}}</td>
                    <td>{{sec1s[k]}}x{{plan[k][2]}}</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        function round2(num) {
            return Math.round(num * 100)/100;
        }
        new Vue({
            el: '#app',
            data: {
                mains: [6, 0, 0, 0, 0, 0],
                sec0s: [8, 0, 0, 0, 0, 0],
                sec1s: [6, 0, 0, 0, 0, 0],
                msp2ms: 8,
                att2ms: 2.5,
                allmstatp: 713,
                cdmg82msp: 25,
                boss402attp: 10,
                ied2boss: 0.9,
                allatt: 8779,
                allattp: 126,
                allmstat: 74075,
                scatt5: 0, sccd35: 0, scms100: 0, scboss: 0, scied: 0, scdmg75: 0,
                mainlevs: [0, 1, 2, 3, 4, 6, 8, 10, 13, 16, 20],
                result: 0,
                plan: null
            },
            methods: {
                calc_score() {
                    this.scatt5 = round2(5 * this.att2ms);
                    this.sccd35 = round2(0.35 * this.cdmg82msp / 8 * this.msp2ms);
                    this.scms100 = round2(100 * 100 / this.allmstatp);
                    let baseatt = this.allatt / (1 + this.allattp / 100);
                    let attp2att = (baseatt * 0.01) / (1 + this.allattp / 100);
                    this.scboss = round2(attp2att * this.att2ms * this.boss402attp / 40);
                    this.scied = round2(this.scboss * this.ied2boss);
                    this.scdmg75 = round2(this.scboss * 0.75);
                },
                search() {
                    let scs = [this.scatt5, this.sccd35, this.scms100, this.scboss, this.scied, this.scdmg75];
                    let sc = new Array(2**6);
                    let method = new Array(2**6);
                    for(var i = 0;i < sc.length; i++){
                        sc[i] = new Array(3**6).fill(0);
                        method[i] = new Array(3**6);
                        for (var j=0; j < method[i].length; j++)
                            method[i][j] = new Array(18).fill(-1);
                    }
                    let que = [0, 0], qh = 0;
                    while (qh < que.length) {
                        let curm = que[qh], curs = que[qh+1];  qh += 2;
                        let avam = [], avas = [];
                        for (let i=0; i < 6; i ++) {
                            if ((curm & (1 << i)) == 0) avam.push(i);
                            if (parseInt(curs / (3**i)) % 3 < 2) avas.push(i);
                        }
                        console.log(curm, curs, avam, avas, method[curm][curs]);
                        let newscore = 0;
                        for (let i=0; i < avam.length; i ++) {
                            let newm = curm | (1 << avam[i]);
                            let news = curs;
                            let positions = method[curm][curs];
                            for (let j=0; j < 6; j ++) {
                                if (positions[j] >= 0) continue;
                                if (avam[i] == positions[j%6]) continue;
                                if (avam[i] == positions[j%6+6]) continue;
                                if (avam[i] == positions[j%6+12]) continue;
                                newscore = sc[curm][curs] + this.mainlevs[this.mains[j]] * scs[avam[i]];
                                if (newscore > sc[newm][news]) {
                                    if (sc[newm][news] == 0) que.push(newm, news);
                                    sc[newm][news] = newscore;
                                    for (let k=0; k < 18; k ++)
                                        method[newm][news][k] = method[curm][curs][k];
                                    method[newm][news][j] = avam[i];
                                }
                            }
                        }    
                        for (let i=0; i < avas.length; i ++) {
                            let newm = curm;
                            let news = curs + (3 ** avas[i]);
                            let positions = method[curm][curs];
                            for (let j=0; j < 12; j ++) {
                                if (positions[6+j] >= 0) continue;
                                if (avas[i] == positions[j%6]) continue;
                                if (avas[i] == positions[j%6+6]) continue;
                                if (avas[i] == positions[j%6+12]) continue;
                                if (j < 6) newscore = sc[curm][curs] + this.sec0s[j] * scs[avas[i]];
                                else newscore = sc[curm][curs] + this.sec1s[j-6] * scs[avas[i]];
                                if (newscore > sc[newm][news]) {
                                    if (sc[newm][news] == 0) que.push(newm, news);
                                    sc[newm][news] = newscore;
                                    for (let k=0; k < 18; k ++)
                                        method[newm][news][k] = method[curm][curs][k];
                                    method[newm][news][6+j] = avas[i];
                                }
                            }
                        }
                    }
                    this.result = sc[2**6-1][3**6-1];
                    let plan = method[2**6-1][3**6-1];
                    this.plan = [];
                    let strs = ['att', 'critdmg', 'finalstat', 'boss', 'ied', 'dmg'];
                    let nums = [5, 0.35, 100, 1, 1, 0.75];
                    for (let i=0; i < 6; i ++) {
                        let cur = [];
                        for (let j=0; j < 3; j ++) {
                            let obj = plan[6*j+i]; 
                            let lev = (j == 0 ? this.mainlevs[this.mains[i]] : (j == 1 ? this.sec0s[i] : this.sec1s[i]));
                            let num = nums[obj] * lev;
                            let equstat = round2(scs[obj] * lev);
                            let ifpr = "%";
                            if (obj == 0 || obj == 2) ifpr = "";
                            let sr = strs[obj] + ' +' + num + ifpr + ' (=' + equstat + ' m.stat)';
                            cur.push(sr);
                        }
                        this.plan.push(cur);
                    }
                }
            },
            created: function() {
                this.calc_score();
            },
            watch: {
                sec0s() {
                    for (let i=0; i < 6; i ++) {
                        let newlev = 20 - this.mains[i] - this.sec0s[i];
                        if (this.sec1s[i] == 0 && newlev >= 0 && newlev <= 10) this.sec1s[i] = newlev;
                    }
                },
                mains() {
                    for (let i=0; i < 6; i ++) {
                        let newlev = 20 - this.mains[i] - this.sec0s[i];
                        if (this.sec1s[i] == 0 && newlev >= 0 && newlev <= 10) this.sec1s[i] = newlev;
                    }
                },
                allmstat() { this.calc_score(); },
                msp2ms() { this.calc_score(); },
                att2ms() { this.calc_score(); },
                allmstatp() { this.calc_score(); },
                cdmg82msp() { this.calc_score(); },
                boss402attp() { this.calc_score(); },
                ied2boss() { this.calc_score(); },
                allatt() { this.calc_score(); },
                allattp() { this.calc_score(); }         
            }

        });
    </script>
</body>
</html>
